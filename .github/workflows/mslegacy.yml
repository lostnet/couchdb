name: MSLegacy

on: [workflow_dispatch,push]

env:
  MOZTOOLS_PATH: C:\mozilla-build\msys\bin;C:\mozilla-build\bin
  LIBCLANG_PATH: C:\Program Files\LLVM\lib
  AUTOCONF: C:\mozilla-build\msys\local\bin\autoconf-2.13
  NATIVE_WIN32_PYTHON: C:\mozilla-build\python\python2.7.exe
  LIB: C:\relax\vcpkg\installed\x64-windows\lib
  INCLUDE: C:\relax\vcpkg\installed\x64-windows\include
  LIBPATH: C:\relax\vcpkg\installed\x64-windows\lib
  VCPKG_BIN: C:\relax\vcpkg\installed\x64-windows\bin
  ICU_PATH: ${{github.workspace}}\icubuild\icu4c\bin
  ICU_PKG_CONFIG_PATH: ${{github.workspace}}\icubuild\lib\pkgconfig
  M4: m4
  AWK: awk
  
jobs:
  build:
    runs-on: windows-2016

    steps:
    - uses: actions/checkout@v2

    - name: dump env
      shell: python
      continue-on-error: true
      run: |
        import os
        env = os.environ.copy()
        env['PATH'] = 'C:\\mozilla-build\\msys\\bin;C:\\mozilla-build\\msys\\local\\bin;'+env['PATH']
        print(env)        
        print(env['ICU_PKG_CONFIG_PATH'])

    - name: Install deps on windows
      shell: powershell
      run: |
        Start-BitsTransfer -Source https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe -Destination ./MozillaBuildSetup.exe
        .\MozillaBuildSetup.exe /S | Out-Null

    - name: moz checkout
      uses: actions/checkout@v2
      with:
        repository: mozilla/gecko-dev
        ref: esr78
        path: gecko-dev

    - name: choco install
      run: choco install pkgconfiglite
      
    - name: Install vcpkg dependencies
      shell: pwsh
      run: |
        Install-Module VSSetup -Scope CurrentUser -Force
        vcpkg.exe install icu
        vcpkg.exe integrate install
        
    - name: find things
      shell: bash
      continue-on-error: true
      run: |
        find icubuild -name \*.pc -print
        find icubuild -name icu-config -print
        find /c/mozilla-build -type f -name autoconf-2.13 -print
        ls -l /c/mozilla-build/msys/local/bin/autoconf-2.13
      
    - name: autoconf mozjs
      shell: python
      working-directory: gecko-dev\js\src
      continue-on-error: true
      run: |
        import subprocess
        import os
        env = os.environ.copy()
        env['PATH'] = 'C:\\mozilla-build\\msys\\bin;C:\\mozilla-build\\msys\\local\\bin;'+env['PATH']
        print(env['PATH'])        
        subprocess.run(["autoconf-2.13"], env=env)
        
    - name: builddir for mozjs
      working-directory: gecko-dev\js\src
      run: mkdir build_OPT.OBJ

    - name: conf mozjs
      working-directory: gecko-dev\js\src\build_OPT.OBJ
      shell: python
      env:
        SRCDIR: ${ github.workspace}\gecko-dev\js\src
        OLD_CONFIGURE: ${ github.workspace }\gecko-dev\js\src\old-configure
        TOPSRCDIR: ${ github.workspace }\gecko-dev
        LIB: "C:\\relax\\vcpkg\\installed\\x64-windows\\lib"
        INCLUDE: "C:\\relax\\vcpkg\\installed\\x64-windows\\include"
        LIBPATH: "C:\\relax\\vcpkg\\installed\\x64-windows\\lib"
        PKG_CONFIG_PATH: "C:\\relax\\vcpkg\\installed\\x64-windows\\lib\\pkgconfig"
      run: |
        import subprocess
        import os
        env = os.environ.copy()
        env['PATH'] = env['ICU_PATH']+';'+env['PATH']
        subprocess.run(["python.EXE", "../../../configure.py", "--enable-project=js", "--disable-ctypes", "--disable-jit", "--disable-jemalloc", "--enable-optimize", "--enable-hardening", "--with-intl-api", "--build-backends=RecursiveMake", "--with-visual-studio-version=2017", "--with-system-icu", "--disable-debug", "--enable-gczeal", "--target=x86_64-pc-mingw32", "--host=x86_64-pc-mingw32", "--prefix=/c/relax/vcpkg/installed/x64-windows"], env=env)
